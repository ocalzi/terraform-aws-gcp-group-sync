name: Release - Terraform Module

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  # Run full CI before releasing
  validate:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.8.5"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Run Terraform Tests
        run: terraform test -verbose

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD)
          fi
          # Write to file for the release body
          cat <<EOF > changelog.md
          ## What's Changed

          ${CHANGELOG}

          ## Usage

          \`\`\`hcl
          module "gcp_to_aws_group_sync" {
            source  = "github.com/ocalzi/gcp-to-aws-group-sync?ref=${{ steps.version.outputs.VERSION }}"

            group_mappings = {
              admins = {
                gcp_group_email = "admins@yourdomain.com"
                aws_role_name   = "GCP-Admin-Role"
                aws_policy_arn  = "arn:aws:iam::aws:policy/AdministratorAccess"
              }
            }
          }
          \`\`\`

          > **Terraform Registry**: When this repo is renamed to \`terraform-aws-gcp-group-sync\`,
          > it will be publishable to the [Terraform Registry](https://registry.terraform.io/).
          > Until then, use the GitHub source URL above.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: ${{ steps.version.outputs.VERSION }}
          body_path: changelog.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-rc') || contains(steps.version.outputs.VERSION, '-beta') || contains(steps.version.outputs.VERSION, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
